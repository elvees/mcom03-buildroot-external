#!/usr/bin/env bash

# Be cautious with environment variables collision! Buildroot sets some of them.
# To test script run it with OUT=/dev/stdout.

[[ -v OUT ]] || OUT="$TARGET_DIR"/boot/extlinux/extlinux.conf

[[ -v ROOT ]] || ROOT=/dev/mmcblk0p1
[[ -v CONSOLE ]] || CONSOLE=ttyS0,115200n8

if [[ ! -v CMDLINE ]]; then
    # Mostly we use USB flash drives and solid-state drives to store rootfs.
    # The ext2 is recommended over journaling file systems on the such drivers.
    # The ext2 performs fewer writes than ext4 because there is no journaling.
    CMDLINE="${CONSOLE:+console=$CONSOLE} ${ROOT:+root=$ROOT rootfstype=ext2 ro,noauto rootwait}"
fi

if [[ -v FDT ]]; then
    FDTCMD=FDT
else
    FDTCMD=FDTDIR
fi

mkdir -p "${OUT%/*}"

cat > "$OUT" <<EOF
LABEL default
    LINUX /boot/Image
    $FDTCMD /boot/elvees/$FDT
    ${CMDLINE:+APPEND $CMDLINE}
EOF
